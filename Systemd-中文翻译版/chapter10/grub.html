<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=utf-8" />
    <title>
      10.4.&nbsp;使用 GRUB 设定引导过程
    </title>
    <link rel="stylesheet" type="text/css" href="../stylesheets/lfs.css" />
    <meta name="generator" content="DocBook XSL Stylesheets V1.79.1" />
    <link rel="stylesheet" href="../stylesheets/lfs-print.css" type=
    "text/css" media="print" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>
  <body class="lfs" id="lfs-20200927-systemd，中文翻译版">
    <div class="navheader">
      <h4>
        Linux From Scratch - 版本 20200927-systemd，中文翻译版
      </h4>
      <h3>
        第&nbsp;10&nbsp;章&nbsp;使 LFS 系统可引导
      </h3>
      <ul>
        <li class="prev">
          <a accesskey="p" href="kernel.html" title="Linux-5.8.9">上一页</a>
          <p>
            Linux-5.8.9
          </p>
        </li>
        <li class="next">
          <a accesskey="n" href="../chapter11/chapter11.html" title=
          "尾声">下一页</a>
          <p>
            尾声
          </p>
        </li>
        <li class="up">
          <a accesskey="u" href="chapter10.html" title=
          "第&nbsp;10&nbsp;章&nbsp;使 LFS 系统可引导">上一级</a>
        </li>
        <li class="home">
          <a accesskey="h" href="../index.html" title=
          "Linux From Scratch - 版本 20200927-systemd，中文翻译版">起始页</a>
        </li>
      </ul>
    </div>
    <div class="wrap" lang="zh-cn" xml:lang="zh-cn">
      <h1 class="sect1">
        <a id="ch-bootable-grub" name="ch-bootable-grub"></a>10.4. 使用 GRUB
        设定引导过程
      </h1>
      <div class="sect2" lang="zh-cn" xml:lang="zh-cn">
        <h2 class="sect2">
          10.4.1. 概述
        </h2>
        <div class="admon warning">
          <img alt="[警告]" src="../images/warning.png" />
          <h3>
            警告
          </h3>
          <p>
            如果您不小心错误地配置了 GRUB，可能导致您的系统完全无法使用，除非使用 CD-ROM 或可引导的 USB
            存储器等备用引导设备。本节不是引导您的 LFS 系统的唯一方案，您可能只要修改现有的启动加载器 (如
            Grub-Legacy、GRUB2 或 LILO) 配置即可引导 LFS。
          </p>
        </div>
        <p>
          您务必保证自己拥有一个紧急引导磁盘，它在计算机不可用 (无法引导) 时能够 <span class=
          "quote">“<span class="quote">抢修</span>”</span>
          计算机。如果您现在还没有引导设备，您可以执行以下命令创建一个。在运行下列命令前，您需要跳到 BLFS，安装包含
          <strong class="userinput"><code>xorriso</code></strong> 的 <a class=
          "ulink" href=
          "http://www.linuxfromscratch.org/blfs/view/svn/multimedia/libisoburn.html">
          libisoburn</a> 软件包：
        </p>
        <pre class="userinput"><kbd class="command">cd /tmp 
grub-mkrescue --output=grub-img.iso 
xorriso -as cdrecord -v dev=/dev/cdrw blank=as_needed grub-img.iso</kbd></pre>
        <div class="admon note">
          <img alt="[注意]" src="../images/note.png" />
          <h3>
            注意
          </h3>
          <p>
            为了在使用 UEFI 的宿主系统上引导 LFS，在构建内核时，需要启用 CONFIG_EFI_STUB
            功能，正如上一节所述。不过，可以使用 GRUB2 在没有该功能的情况下引导 LFS，前提是在系统 BIOS 设定中关闭 UEFI
            模式和安全引导 (Secure Boot) 功能。关于在 UEFI 环境下引导 LFS 的的详细信息，可以参阅 <a class=
            "ulink" href=
            "http://www.linuxfromscratch.org/hints/downloads/files/lfs-uefi.txt">
            lfs-uefi.txt hint</a>，它位于
            http://www.linuxfromscratch.org/hints/downloads/files/lfs-uefi.txt。
          </p>
        </div>
      </div>
      <div class="sect2" lang="zh-cn" xml:lang="zh-cn">
        <h2 class="sect2">
          10.4.2. GRUB 命名惯例
        </h2>
        <p>
          GRUB 使用一种独特的命名结构，为驱动器和分区命名。分区名的形式为 <span class=
          "emphasis"><em>(hdn,m)</em></span>，这里 <span class=
          "emphasis"><em>n</em></span> 是硬盘驱动器编号，<span class=
          "emphasis"><em>m</em></span> 是分区编号。硬盘驱动器编号从 0 开始，但分区号对于主分区来说从 1
          开始，而对于扩展分区来说从 5 开始。例如，分区 <code class="filename">sda1</code> 在 GRUB
          中的名字是 <span class="emphasis"><em>(hd0, 1)</em></span>，而
          <code class="filename">sda3</code> 的名字是 <span class=
          "emphasis"><em>(hd1, 3)</em></span>。和 Linux 不同，GRUB 不认为 CD-ROM
          驱动器属于硬盘驱动器。例如，如果在 <code class="filename">hdb</code> 上有一个 CD-ROM
          驱动器，而 <code class="filename">hdc</code> 上有第二个硬盘驱动器，则第二个硬盘驱动器仍然名为
          <span class="emphasis"><em>hd1</em></span>。
        </p>
      </div>
      <div class="sect2" lang="zh-cn" xml:lang="zh-cn">
        <h2 class="sect2">
          10.4.3. 设定 GRUB 配置
        </h2>
        <p>
          GRUB 的工作方式是，将数据写入硬盘的第一个物理磁道。这里不属于任何文件系统，在启动时，第一个物理磁道中的程序从引导分区加载
          GRUB 模块，默认在 /boot/grub 中查找模块。
        </p>
        <p>
          引导分区的位置由负责进行配置的用户自己决定，作者推荐创建一个小的 (建议大小为 200 MB) 分区，专门存放引导信息。这样，不同的
          Linux 系统 (无论是 LFS 还是商业发行版)
          在启动时和启动后都能访问相同的引导文件。如果您选择这样做，您需要挂载这个单独的分区，将 <code class=
          "filename">/boot</code> 中已有的文件 (例如上一节中构建的内核)
          移动到新的分区中。之后，解除该分区的挂载，并将它挂载为 <code class=
          "filename">/boot</code>。另外，还要注意更新 <code class=
          "filename">/etc/fstab</code>。
        </p>
        <p>
          直接使用 LFS 分区也是可以的，但这样在配置多系统启动时比较麻烦。
        </p>
        <p>
          根据以上信息，确定 LFS 根分区 (或 boot 分区，如果使用了独立的 boot 分区) 的名称。下面假设 LFS 根分区 (或
          boot 分区) 是 <code class="filename">sda2</code>。
        </p>
        <p>
          将 GRUB 文件安装到<code class="filename">/boot/grub</code> 并设定引导磁道：
        </p>
        <div class="admon warning">
          <img alt="[警告]" src="../images/warning.png" />
          <h3>
            警告
          </h3>
          <p>
            以下命令会覆盖当前启动引导器，如果这不是您希望的，不要运行该命令。例如，如果您使用第三方启动引导器管理主引导记录 (MBR)。
          </p>
        </div>
        <pre class="userinput"><kbd class=
        "command">grub-install /dev/sda</kbd></pre>
        <div class="admon note">
          <img alt="[注意]" src="../images/note.png" />
          <h3>
            注意
          </h3>
          <p>
            如果系统是使用 UEFI 引导的，<span class=
            "command"><strong>grub-install</strong></span> 会试图为 <span class=
            "emphasis"><em>x86_64-efi</em></span> 目标安装文件，但它们并未在第 6
            章中安装。如果出现了这类问题，请在以上命令中添加 <code class="option">--target
            i386-pc</code> 选项。
          </p>
        </div>
      </div>
      <div class="sect2" lang="zh-cn" xml:lang="zh-cn">
        <h2 class="sect2">
          <a id="grub-cfg" name="grub-cfg"></a>10.4.4. 创建 GRUB 配置文件
        </h2>
        <p>
          生成 <code class="filename">/boot/grub/grub.cfg</code>：
        </p>
        <pre class="userinput"><kbd class=
        "command">cat &gt; /boot/grub/grub.cfg &lt;&lt; "EOF"
<code class="literal"># Begin /boot/grub/grub.cfg
set default=0
set timeout=5

insmod ext2
set root=(hd0,2)

menuentry "GNU/Linux, Linux 5.8.9-lfs-20200927-systemd" {
        linux   /boot/vmlinuz-5.8.9-lfs-20200927-systemd root=/dev/sda2 ro
}</code>
EOF</kbd></pre>
        <div class="admon note">
          <img alt="[注意]" src="../images/note.png" />
          <h3>
            注意
          </h3>
          <p>
            从 <span class=
            "application">GRUB</span>的视角来看，内核文件的位置相对于它使用的分区。如果您使用了单独的 /boot
            分区，需要从上面的 <span class="emphasis"><em>linux</em></span> 行删除
            /boot，然后修改 <span class="emphasis"><em>set root</em></span> 行，指向
            /boot 分区。
          </p>
        </div>
        <p>
          GRUB
          是一个很强大的程序，它提供了非常多的选项，可以支持多种设备、操作系统和分区类型，还有很多用于定制启动屏幕、声音、鼠标输入等的选项。这些选项的细节超过了本书的范围，不予讨论。
        </p>
        <div class="admon caution">
          <img alt="[小心]" src="../images/caution.png" />
          <h3>
            小心
          </h3>
          <p>
            有一个命令 <span class="application">grub-mkconfig</span>
            被用于自动创建配置文件。它使用 /etc/grub.d 中的脚本创建新配置文件，这会覆盖您手动编写的
            grub.cfg。这些脚本主要是为非源代码发行版设计的，在 LFS
            中不推荐使用。但是，如果您安装了商业发行版，它很可能在发行版中被运行，记得备份 grub.cfg 以防它被覆盖。
          </p>
        </div>
      </div>
    </div>
    <div class="navfooter">
      <ul>
        <li class="prev">
          <a accesskey="p" href="kernel.html" title="Linux-5.8.9">上一页</a>
          <p>
            Linux-5.8.9
          </p>
        </li>
        <li class="next">
          <a accesskey="n" href="../chapter11/chapter11.html" title=
          "尾声">下一页</a>
          <p>
            尾声
          </p>
        </li>
        <li class="up">
          <a accesskey="u" href="chapter10.html" title=
          "第&nbsp;10&nbsp;章&nbsp;使 LFS 系统可引导">上一级</a>
        </li>
        <li class="home">
          <a accesskey="h" href="../index.html" title=
          "Linux From Scratch - 版本 20200927-systemd，中文翻译版">起始页</a>
        </li>
      </ul>
    </div>
  </body>
</html>
