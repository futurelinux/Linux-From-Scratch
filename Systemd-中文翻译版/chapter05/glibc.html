<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=utf-8" />
    <title>
      5.5.&nbsp;Glibc-2.32
    </title>
    <link rel="stylesheet" type="text/css" href="../stylesheets/lfs.css" />
    <meta name="generator" content="DocBook XSL Stylesheets V1.79.1" />
    <link rel="stylesheet" href="../stylesheets/lfs-print.css" type=
    "text/css" media="print" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>
  <body class="lfs" id="lfs-20200927-systemd，中文翻译版">
    <div class="navheader">
      <h4>
        Linux From Scratch - 版本 20200927-systemd，中文翻译版
      </h4>
      <h3>
        第&nbsp;5&nbsp;章&nbsp;编译交叉工具链
      </h3>
      <ul>
        <li class="prev">
          <a accesskey="p" href="linux-headers.html" title=
          "Linux-5.8.9 API 头文件">上一页</a>
          <p>
            Linux-5.8.9 API 头文件
          </p>
        </li>
        <li class="next">
          <a accesskey="n" href="gcc-libstdc++-pass1.html" title=
          "GCC-10.2.0 中的 Libstdc++，第一遍">下一页</a>
          <p>
            GCC-10.2.0 中的 Libstdc++，第一遍
          </p>
        </li>
        <li class="up">
          <a accesskey="u" href="chapter05.html" title=
          "第&nbsp;5&nbsp;章&nbsp;编译交叉工具链">上一级</a>
        </li>
        <li class="home">
          <a accesskey="h" href="../index.html" title=
          "Linux From Scratch - 版本 20200927-systemd，中文翻译版">起始页</a>
        </li>
      </ul>
    </div>
    <div class="wrap" lang="zh-cn" xml:lang="zh-cn">
      <h1 class="sect1">
        <a id="ch-tools-glibc" name="ch-tools-glibc"></a>5.5. Glibc-2.32
      </h1>
      <div class="package" lang="zh-cn" xml:lang="zh-cn">
        <p>
          Glibc 软件包包含主要的 C
          语言库。它提供用于分配内存、检索目录、打开和关闭文件、读写文件、字符串处理、模式匹配、算术等用途的基本子程序。
        </p>
        <div class="segmentedlist">
          <div class="seglistitem">
            <div class="seg">
              <strong class="segtitle">估计构建时间:</strong> <span class=
              "segbody">4.6 SBU</span>
            </div>
            <div class="seg">
              <strong class="segtitle">需要硬盘空间:</strong> <span class=
              "segbody">762 MB</span>
            </div>
          </div>
        </div>
      </div>
      <div class="installation" lang="zh-cn" xml:lang="zh-cn">
        <h2 class="sect2">
          5.5.1. 安装 Glibc
        </h2>
        <p>
          首先，创建一个 LSB 兼容性符号链接。另外，对于 x86_64，创建一个动态链接器正常工作所必须的符号链接：
        </p>
        <pre class="userinput"><kbd class="command">case $(uname -m) in
    i?86)   ln -sfv ld-linux.so.2 $LFS/lib/ld-lsb.so.3
    ;;
    x86_64) ln -sfv ../lib/ld-linux-x86-64.so.2 $LFS/lib64
            ln -sfv ../lib/ld-linux-x86-64.so.2 $LFS/lib64/ld-lsb-x86-64.so.3
    ;;
esac</kbd></pre>
        <p>
          一些 Glibc 程序使用与 FHS 不兼容的 <code class="filename">/var/db</code>
          目录存放它们的运行时数据。下面应用一个补丁，使得这些程序在 FHS 兼容的位置存放运行时数据：
        </p>
        <pre class="userinput"><kbd class=
        "command">patch -Np1 -i ../glibc-2.32-fhs-1.patch</kbd></pre>
        <p>
          Glibc 文档推荐在一个专用目录中构建 Glibc：
        </p>
        <pre class="userinput"><kbd class="command">mkdir -v build
cd       build</kbd></pre>
        <p>
          下面，准备编译 Glibc：
        </p>
        <pre class="userinput"><kbd class=
        "command">../configure                             \
      --prefix=/usr                      \
      --host=$LFS_TGT                    \
      --build=$(../scripts/config.guess) \
      --enable-kernel=3.2                \
      --with-headers=$LFS/usr/include    \
      libc_cv_slibdir=/lib</kbd></pre>
        <div class="variablelist">
          <p class="title">
            <strong>配置选项的含义：</strong>
          </p>
          <dl class="variablelist">
            <dt>
              <span class="term"><em class="parameter"><code>--host=$LFS_TGT,
              --build=$(../scripts/config.guess)</code></em></span>
            </dt>
            <dd>
              <p>
                在它们的共同作用下，Glibc 的构建系统将自身配置为使用 <code class=
                "filename">$LFS/tools</code> 中的交叉链接器和交叉编译器，进行交叉编译。
              </p>
            </dd>
            <dt>
              <span class="term"><em class=
              "parameter"><code>--enable-kernel=3.2</code></em></span>
            </dt>
            <dd>
              <p>
                该选项告诉 Glibc 编译出支持 3.2 版或者更新的 Linux 内核，这样就不会使用那些为更老内核准备的替代方案。
              </p>
            </dd>
            <dt>
              <span class="term"><em class=
              "parameter"><code>--with-headers=$LFS/usr/include</code></em></span>
            </dt>
            <dd>
              <p>
                该选项告诉 Glibc 在编译过程中，使用 $LFS/usr/include
                目录中的头文件，这样它就知道内核拥有哪些特性，并据此对自身进行优化。
              </p>
            </dd>
            <dt>
              <span class="term"><em class=
              "parameter"><code>libc_cv_slibdir=/lib</code></em></span>
            </dt>
            <dd>
              <p>
                在 64 位机器上，这保证将库安装到 /lib，而不是默认的 /lib64。
              </p>
            </dd>
          </dl>
        </div>
        <p>
          在当前阶段，可能出现下列警告：
        </p>
        <div class="blockquote">
          <blockquote class="blockquote">
            <pre class="screen"><code class=
            "computeroutput">configure: WARNING:
*** These auxiliary programs are missing or
*** incompatible versions: msgfmt
*** some features will be disabled.
*** Check the INSTALL file for required versions.</code></pre>
          </blockquote>
        </div>
        <p>
          <span class="command"><strong>msgfmt</strong></span>
          程序的缺失或不兼容一般是无害的。<span class=
          "command"><strong>msgfmt</strong></span> 程序是 Gettext
          软件包的一部分，宿主发行版应该提供它。
        </p>
        <div class="admon note">
          <img alt="[注意]" src="../images/note.png" />
          <h3>
            注意
          </h3>
          <p>
            有报告称该软件包在并行构建时可能失败，如果发生了这种情况，加上 "-j1" 选项重新执行 make 命令。
          </p>
        </div>
        <p>
          编译该软件包：
        </p>
        <pre class="userinput"><kbd class="command">make</kbd></pre>
        <p>
          安装该软件包：
        </p>
        <div class="admon warning">
          <img alt="[警告]" src="../images/warning.png" />
          <h3>
            警告
          </h3>
          <p>
            如果 <code class="envar">LFS</code> 没有正确设定，而且您不顾本书的建议以 root
            用户身份进行构建，下面的命令会将新构建的 glibc
            安装到您的宿主系统中，这很可能导致宿主系统完全无法使用。因此，请再次检查该环境变量是否已经为 <code class=
            "systemitem">lfs</code> 用户设定好。
          </p>
        </div>
        <pre class="userinput"><kbd class=
        "command">make DESTDIR=$LFS install</kbd></pre>
        <div class="variablelist">
          <p class="title">
            <strong><span class="command"><strong>make
            install</strong></span> 选项的含义：</strong>
          </p>
          <dl class="variablelist">
            <dt>
              <span class="term"><em class=
              "parameter"><code>DESTDIR=$LFS</code></em></span>
            </dt>
            <dd>
              <p>
                多数软件包使用 <code class="envar">DESTDIR</code>
                变量指定软件包应该安装的位置。如果不设定它，默认值为根 (<code class="filename">/</code>)
                目录。这里我们指定将软件包安装到 <code class=
                "filename">$LFS</code>，它在<a class="xref" href=
                "../chapter07/chroot.html" title=
                "7.4.&nbsp;进入 Chroot 环境">第&nbsp;7.4&nbsp;节 “进入 Chroot
                环境”</a>之后将成为根目录。
              </p>
            </dd>
          </dl>
        </div>
        <div class="admon caution">
          <img alt="[小心]" src="../images/caution.png" />
          <h3>
            小心
          </h3>
          <p>
            现在我们不可避免地要停下确认新工具链的各基本功能 (编译和链接) 能如我们所预期的那样工作。执行以下命令进行完整性检查：
          </p>
          <pre class="userinput"><kbd class=
          "command">echo 'int main(){}' &gt; dummy.c
$LFS_TGT-gcc dummy.c
readelf -l a.out | grep '/ld-linux'</kbd></pre>
          <p>
            如果一切正常，那么应该没有错误消息，而且最后一行命令应该输出下列格式的内容：
          </p>
          <pre class="screen"><code class=
          "computeroutput">[Requesting program interpreter: /lib64/ld-linux-x86-64.so.2]</code></pre>
          <p>
            注意，对于 32 位机器，解释器的名字将会是 <code class=
            "filename">/lib/ld-linux.so.2</code>。
          </p>
          <p>
            如果输出不像上面描述的那样，或者根本没有输出，就说明出了问题。检查并重新跟踪各个步骤，找到出问题的地方并修正它。在继续构建之前，必须解决这个问题。
          </p>
          <p>
            检验步骤顺利完成后，清理测试文件：
          </p>
          <pre class="userinput"><kbd class=
          "command">rm -v dummy.c a.out</kbd></pre>
        </div>
        <div class="admon note">
          <img alt="[注意]" src="../images/note.png" />
          <h3>
            注意
          </h3>
          <p>
            在下一章中，构建各软件包的过程可以作为对工具链是否正常构建的额外检查。如果 一些软件包，特别是第二遍的 Binutils 或者
            GCC 不能构建，说明在之前安装 Binutils，GCC，或者 Glibc 时出了问题。
          </p>
        </div>
        <p>
          现在我们的交叉工具链已经构建完成，可以完成 limits.h 头文件的安装。为此，运行 GCC 开发者提供的一个工具：
        </p>
        <pre class="userinput"><kbd class=
        "command">$LFS/tools/libexec/gcc/$LFS_TGT/10.2.0/install-tools/mkheaders</kbd></pre>
      </div>
      <div class="content" lang="zh-cn" xml:lang="zh-cn">
        <p>
          该软件包的详细信息可以在<a class="xref" href=
          "../chapter08/glibc.html#contents-glibc" title=
          "8.8.3.&nbsp;Glibc 的内容">第&nbsp;8.8.3&nbsp;节 “Glibc 的内容”</a>中找到。
        </p>
      </div>
    </div>
    <div class="navfooter">
      <ul>
        <li class="prev">
          <a accesskey="p" href="linux-headers.html" title=
          "Linux-5.8.9 API 头文件">上一页</a>
          <p>
            Linux-5.8.9 API 头文件
          </p>
        </li>
        <li class="next">
          <a accesskey="n" href="gcc-libstdc++-pass1.html" title=
          "GCC-10.2.0 中的 Libstdc++，第一遍">下一页</a>
          <p>
            GCC-10.2.0 中的 Libstdc++，第一遍
          </p>
        </li>
        <li class="up">
          <a accesskey="u" href="chapter05.html" title=
          "第&nbsp;5&nbsp;章&nbsp;编译交叉工具链">上一级</a>
        </li>
        <li class="home">
          <a accesskey="h" href="../index.html" title=
          "Linux From Scratch - 版本 20200927-systemd，中文翻译版">起始页</a>
        </li>
      </ul>
    </div>
  </body>
</html>
