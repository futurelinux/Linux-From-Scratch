<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=utf-8" />
    <title>
      10.3.&nbsp;Linux-5.8.9
    </title>
    <link rel="stylesheet" type="text/css" href="../stylesheets/lfs.css" />
    <meta name="generator" content="DocBook XSL Stylesheets V1.79.1" />
    <link rel="stylesheet" href="../stylesheets/lfs-print.css" type=
    "text/css" media="print" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>
  <body class="lfs" id="lfs-20200915-systemd，中文翻译版">
    <div class="navheader">
      <h4>
        Linux From Scratch - 版本 20200915-systemd，中文翻译版
      </h4>
      <h3>
        第&nbsp;10&nbsp;章&nbsp;使 LFS 系统可引导
      </h3>
      <ul>
        <li class="prev">
          <a accesskey="p" href="fstab.html" title="创建 /etc/fstab 文件">上一页</a>
          <p>
            创建 /etc/fstab 文件
          </p>
        </li>
        <li class="next">
          <a accesskey="n" href="grub.html" title="使用 GRUB 设定引导过程">下一页</a>
          <p>
            使用 GRUB 设定引导过程
          </p>
        </li>
        <li class="up">
          <a accesskey="u" href="chapter10.html" title=
          "第&nbsp;10&nbsp;章&nbsp;使 LFS 系统可引导">上一级</a>
        </li>
        <li class="home">
          <a accesskey="h" href="../index.html" title=
          "Linux From Scratch - 版本 20200915-systemd，中文翻译版">起始页</a>
        </li>
      </ul>
    </div>
    <div class="wrap" lang="zh-cn" xml:lang="zh-cn">
      <h1 class="sect1">
        <a id="ch-bootable-kernel" name="ch-bootable-kernel"></a>10.3.
        Linux-5.8.9
      </h1>
      <div class="package" lang="zh-cn" xml:lang="zh-cn">
        <p>
          Linux 软件包包含 Linux 内核。
        </p>
        <div class="segmentedlist">
          <div class="seglistitem">
            <div class="seg">
              <strong class="segtitle">估计构建时间:</strong> <span class=
              "segbody">5.0 - 125.0 SBU (一般约 9 SBU)</span>
            </div>
            <div class="seg">
              <strong class="segtitle">需要硬盘空间:</strong> <span class=
              "segbody">1200 - 6750 MB (一般约 1500 MB)</span>
            </div>
          </div>
        </div>
      </div>
      <div class="installation" lang="zh-cn" xml:lang="zh-cn">
        <h2 class="sect2">
          10.3.1. 安装内核
        </h2>
        <p>
          构建内核需要三步 —— 配置、编译、安装。阅读内核源代码树中的 <code class=
          "filename">README</code> 文件，了解不同于本手册的内核配置方法。
        </p>
        <p>
          运行以下命令，准备编译内核：
        </p>
        <pre class="userinput"><kbd class="command">make mrproper</kbd></pre>
        <p>
          该命令确保内核源代码树绝对干净，内核开发组建议在每次编译内核前运行该命令。尽管内核源代码树在解压后应该是干净的，但这并不完全可靠。
        </p>
        <p>
          有多种配置内核选项的方法。例如，通常我们通过目录驱动的界面完成这一工作：
        </p>
        <pre class="userinput"><kbd class=
        "command">make menuconfig</kbd></pre>
        <div class="variablelist">
          <p class="title">
            <strong>以上命令中可选的 make 环境变量及含义：</strong>
          </p>
          <dl class="variablelist">
            <dt>
              <span class="term"><em class=
              "parameter"><code>LANG=&lt;host_LANG_value&gt;
              LC_ALL=</code></em></span>
            </dt>
            <dd>
              <p>
                它们根据宿主使用的 locale 建立 locale 设定。在 UTF-8 Linux
                文本终端下，有时必须这样做才能正确绘制基于 ncurses 的配置菜单接口。
              </p>
              <p>
                在这种情况下，一定要将 <em class=
                "replaceable"><code>&lt;host_LANG_value&gt;</code></em>
                替换成宿主环境中的 <code class="envar">$LANG</code> 变量值。您也可以使用宿主环境中
                <code class="envar">$LC_ALL</code> 或 <code class=
                "envar">$LC_CTYPE</code> 的值代替。
              </p>
            </dd>
            <dt>
              <span class="term"><span class="command"><strong>make
              menuconfig</strong></span></span>
            </dt>
            <dd>
              <p>
                这会启动 ncurses 目录驱动的界面。如果希望了解其他 (图形) 界面，可以输入 <span class=
                "command"><strong>make help</strong></span>。
              </p>
            </dd>
          </dl>
        </div>
        <p>
          阅读 <a class="ulink" href=
          "http://www.linuxfromscratch.org/hints/downloads/files/kernel-configuration.txt">
          http://www.linuxfromscratch.org/hints/downloads/files/kernel-configuration.txt</a>
          了解关于内核配置的一般信息。BLFS 包含一些关于 LFS 之外的软件包需要的特定内核配置的信息，位于<a class="ulink"
          href=
          "http://www.linuxfromscratch.org/blfs/view/svn/longindex.html#kernel-config-index">http://www.linuxfromscratch.org/blfs/view/svn/longindex.html#kernel-config-index</a>
          。另外在 <a class="ulink" href=
          "http://www.kroah.com/lkn/">http://www.kroah.com/lkn/</a>
          也有一些关于配置和构建内核的信息。
        </p>
        <div class="admon note">
          <img alt="[注意]" src="../images/note.png" />
          <h3>
            注意
          </h3>
          <p>
            一个较好的初始内核配置可以通过运行 <span class="command"><strong>make
            defconfig</strong></span> 获得。它会考虑您的当前系统体系结构，将基本内核配置设定到较好的状态。
          </p>
          <p>
            一定要按照以下列表启用/禁用/设定其中列出的内核特性，否则系统可能不能正常工作，甚至根本无法引导：
          </p>
          <pre class="screen">General setup --&gt;
   [*] Control Group support [CONFIG_CGROUPS]
   [ ] Enable deprecated sysfs features to support old userspace tools [CONFIG_SYSFS_DEPRECATED]
   [*] Configure standard kernel features (expert users) [CONFIG_EXPERT] ---&gt;         
      [*] open by fhandle syscalls [CONFIG_FHANDLE]
   [ ] Auditing support [CONFIG_AUDIT]
Processor type and features  ---&gt;
   [*] Enable seccomp to safely compute untrusted bytecode [CONFIG_SECCOMP]
Firmware Drivers  ---&gt;
   [*] Export DMI identification via sysfs to userspace [CONFIG_DMIID]
Networking support  ---&gt;
  Networking options  ---&gt;
   &lt;*&gt; The IPv6 protocol [CONFIG_IPV6]
Device Drivers  ---&gt;
  Generic Driver Options  ---&gt;
   [ ] Support for uevent helper [CONFIG_UEVENT_HELPER]
   [*] Maintain a devtmpfs filesystem to mount at /dev [CONFIG_DEVTMPFS]
   Firmware Loader ---&gt;
      [ ] Enable the firmware sysfs fallback mechanism [CONFIG_FW_LOADER_USER_HELPER]
File systems  ---&gt;
   [*] Inotify support for userspace [CONFIG_INOTIFY_USER]
   &lt;*&gt; Kernel automounter support (supports v3, v4, and v5) [CONFIG_AUTOFS_FS]
  Pseudo filesystems  ---&gt;
   [*] Tmpfs POSIX Access Control Lists [CONFIG_TMPFS_POSIX_ACL]
   [*] Tmpfs extended attributes [CONFIG_TMPFS_XATTR]</pre>
        </div>
        <div class="admon note">
          <img alt="[注意]" src="../images/note.png" />
          <h3>
            注意
          </h3>
          <p>
            尽管 “The IPv6 Protocol” (IPv6 协议支持) 并不是严格要求的，但是 systemd
            开发者强烈推荐启用它。
          </p>
        </div>
        <div class="admon note">
          <img alt="[注意]" src="../images/note.png" />
          <h3>
            注意
          </h3>
          <p>
            如果您的硬件平台使用 UEFI，则 “make defconfig” 命令也会自动加入一些 EFI 相关的内核选项。
          </p>
          <p>
            为了允许从宿主系统的 UEFI 引导环境引导 LFS 内核，您必须选择一个内核选项：
          </p>
          <pre class="screen">Processor type and features  ---&gt;
   [*]   EFI stub support  [CONFIG_EFI_STUB]</pre>
          <p>
            在 LFS 中管理 UEFI 环境的较完整说明包含在 lfs-uefi.txt 中，它位于 <a class="ulink"
            href=
            "http://www.linuxfromscratch.org/hints/downloads/files/lfs-uefi.txt">
            http://www.linuxfromscratch.org/hints/downloads/files/lfs-uefi.txt</a>。
          </p>
        </div>
        <div class="variablelist">
          <p class="title">
            <strong>上述配置选项的含义：</strong>
          </p>
          <dl class="variablelist">
            <dt>
              <span class="term"><em class="parameter"><code>Support for
              uevent helper</code></em></span>
            </dt>
            <dd>
              <p>
                如果启用了该选项，它可能干扰 Udev/Eudev 的设备管理。
              </p>
            </dd>
            <dt>
              <span class="term"><em class="parameter"><code>Maintain a
              devtmpfs</code></em></span>
            </dt>
            <dd>
              <p>
                该选项会使内核自动创建设备节点，即使 Udev 没有运行。Udev
                之后才在这些设备节点的基础上运行，管理它们的访问权限并为它们建立符号链接。所有 Udev/Eudev
                用户都需要启用该选项。
              </p>
            </dd>
          </dl>
        </div>
        <p>
          某些情况下，<span class="command"><strong>make oldconfig</strong></span>
          更为合适。阅读 <code class="filename">README</code> 文件了解更多信息。
        </p>
        <p>
          如果希望的话，也可以将宿主系统的内核配置文件 <code class="filename">.config</code>
          拷贝到解压出的 <code class="filename">linux-5.8.9</code> 目录
          (前提是可以找到该文件)。然而我们不推荐这样做，一般来说，浏览整个配置目录，并从头创建内核配置是更好的选择。
        </p>
        <p>
          编译内核映像和模块：
        </p>
        <pre class="userinput"><kbd class="command">make</kbd></pre>
        <p>
          如果要使用内核模块，可能需要在 <code class="filename">/etc/modprobe.d</code>
          中写入模块配置。讨论模块和内核配置的信息位于<a class="xref" href="../chapter09/udev.html"
          title="9.3.&nbsp;设备和模块管理概述">第&nbsp;9.3&nbsp;节 “设备和模块管理概述”</a>和
          <code class="filename">linux-5.8.9/Documentation</code>
          目录下的内核文档中。另外 <code class="filename">modprobe.d(5)</code> 也可以作为参考。
        </p>
        <p>
          如果内核配置使用了模块，安装它们：
        </p>
        <pre class="userinput"><kbd class=
        "command">make modules_install</kbd></pre>
        <p>
          在内核编译完成后，需要进行额外步骤完成安装，一些文件需要拷贝到 <code class="filename">/boot</code>
          目录中。
        </p>
        <div class="admon caution">
          <img alt="[小心]" src="../images/caution.png" />
          <h3>
            小心
          </h3>
          <p>
            如果宿主系统有单独的 /boot 分区，需要将这些文件拷贝到该分区中。最简单的方法是将宿主系统的 /boot (在 chroot
            之外) 绑定到 /mnt/lfs/boot 再拷贝文件，在<span class=
            "emphasis"><em>宿主系统</em></span>中，以 root 身份执行：
          </p>
          <pre class="userinput"><kbd class=
          "command">mount --bind /boot /mnt/lfs/boot</kbd></pre>
        </div>
        <p>
          指向内核映像的路径可能随机器平台的不同而变化。下面使用的文件名可以依照您的需要改变，但文件名的开头应该保持为 <span class=
          "emphasis"><em>vmlinuz</em></span>，以保证和下一节描述的引导过程自动设定相兼容。下面的命令假定是机器是
          x86 体系结构：
        </p>
        <pre class="userinput"><kbd class=
        "command">cp -iv arch/x86/boot/bzImage /boot/vmlinuz-5.8.9-lfs-20200915-systemd</kbd></pre>
        <p>
          <code class="filename">System.map</code> 是内核符号文件，它将内核 API
          的每个函数入口点和运行时数据结构映射到它们的地址。它被用于调查分析内核可能出现的问题。执行以下命令安装该文件：
        </p>
        <pre class="userinput"><kbd class=
        "command">cp -iv System.map /boot/System.map-5.8.9</kbd></pre>
        <p>
          内核配置文件 <code class="filename">.config</code> 由上述的 <span class=
          "command"><strong>make menuconfig</strong></span>
          步骤生成，包含编译好的内核的所有配置选项。最好能将它保留下来以供日后参考：
        </p>
        <pre class="userinput"><kbd class=
        "command">cp -iv .config /boot/config-5.8.9</kbd></pre>
        <p>
          安装 Linux 内核文档：
        </p>
        <pre class="userinput"><kbd class=
        "command">install -d /usr/share/doc/linux-5.8.9
cp -r Documentation/* /usr/share/doc/linux-5.8.9</kbd></pre>
        <p>
          需要注意的是，在内核源代码目录中可能有不属于 <span class="emphasis"><em>root</em></span>
          的文件。在以 <span class="emphasis"><em>root</em></span> 身份解压源代码包时 (就像我们在
          chroot 环境中所做的那样)，这些文件会获得它们之前在软件包创建者的计算机上的用户和组
          ID。这一般不会造成问题，因为在安装后通常会删除源代码目录树。然而，Linux
          源代码目录树一般会被保留较长时间，这样创建者当时使用的用户 ID 就可能被分配给本机的某个用户，导致该用户拥有内核源代码的写权限。
        </p>
        <div class="admon note">
          <img alt="[注意]" src="../images/note.png" />
          <h3>
            注意
          </h3>
          <p>
            之后在 BLFS 中安装软件包时往往需要修改内核配置。因此，和其他软件包不同，我们在安装好内核后可以不移除源代码树。
          </p>
          <p>
            如果要保留内核源代码树，切换到内核源代码目录，执行 <span class="command"><strong>chown -R
            0:0</strong></span>，以保证 <code class="filename">linux-5.8.9</code>
            目录中所有文件都属于 <span class="emphasis"><em>root</em></span>。
          </p>
        </div>
        <div class="admon warning">
          <img alt="[警告]" src="../images/warning.png" />
          <h3>
            警告
          </h3>
          <p>
            有的内核文档建议创建符号链接 <code class="filename">/usr/src/linux</code>
            指向内核源代码目录，这仅仅适用于 2.6 系列之前的内核。在 LFS 系统上<span class=
            "emphasis"><em>绝对不要</em></span>创建它，因为在构建完基本 LFS
            系统后，它可能在您构建其他软件包时引起问题。
          </p>
        </div>
        <div class="admon warning">
          <img alt="[警告]" src="../images/warning.png" />
          <h3>
            警告
          </h3>
          <p>
            在系统 <code class="filename">include</code> 目录 (即 <code class=
            "filename">/usr/include</code>) 中的内核头文件应该<span class=
            "emphasis"><em>总是</em></span>与构建 Glibc 时使用的内核头文件一致，即保持为<a class=
            "xref" href="../chapter05/linux-headers.html" title=
            "5.4.&nbsp;Linux-5.8.9 API 头文件">第&nbsp;5.4&nbsp;节 “Linux-5.8.9
            API 头文件”</a>中安装的净化头文件。换句话说，<span class=
            "emphasis"><em>永远不要</em></span>用原始内核头文件，或其他版本内核的净化头文件替换它们。
          </p>
        </div>
      </div>
      <div class="configuration" lang="zh-cn" xml:lang="zh-cn">
        <h2 class="sect2">
          <a id="conf-modprobe" name="conf-modprobe"></a>10.3.2. 配置 Linux
          内核模块加载顺序
        </h2>
        <p>
          多数情况下 Linux 内核模块可以自动加载，但有时需要指定加载顺序。负责加载内核模块的程序 <span class=
          "command"><strong>modprobe</strong></span> 和 <span class=
          "command"><strong>insmod</strong></span> 从 <code class=
          "filename">/etc/modprobe.d</code> 下的配置文件中读取加载顺序，例如，如果 USB 驱动程序
          (ehci_hcd、ohci_hcd 和 uhci_hcd) 被构建为模块，则必须按照先加载 echi_hcd，再加载
          ohci_hcd 和 uhci_hcd 的正确顺序，才能避免引导时出现警告信息。
        </p>
        <p>
          为此，执行以下命令创建文件 <code class=
          "filename">/etc/modprobe.d/usb.conf</code>：
        </p>
        <pre class="userinput"><kbd class=
        "command">install -v -m755 -d /etc/modprobe.d
cat &gt; /etc/modprobe.d/usb.conf &lt;&lt; "EOF"
<code class="literal"># Begin /etc/modprobe.d/usb.conf

install ohci_hcd /sbin/modprobe ehci_hcd ; /sbin/modprobe -i ohci_hcd ; true
install uhci_hcd /sbin/modprobe ehci_hcd ; /sbin/modprobe -i uhci_hcd ; true

# End /etc/modprobe.d/usb.conf</code>
EOF</kbd></pre>
      </div>
      <div class="content" lang="zh-cn" xml:lang="zh-cn">
        <h2 class="sect2">
          <a id="contents-kernel" name="contents-kernel"></a>10.3.3. Linux
          的内容
        </h2>
        <div class="segmentedlist">
          <div class="seglistitem">
            <div class="seg">
              <strong class="segtitle">安装的文件:</strong> <span class=
              "segbody">config-5.8.9, <span class=
              "phrase">vmlinuz-5.8.9-lfs-20200915-systemd,</span> 以及
              System.map-5.8.9</span>
            </div>
            <div class="seg">
              <strong class="segtitle">安装的目录:</strong> <span class=
              "segbody">/lib/modules 和 /usr/share/doc/linux-5.8.9</span>
            </div>
          </div>
        </div>
        <div class="variablelist">
          <h3>
            简要描述
          </h3>
          <table border="0" class="variablelist">
            <colgroup>
              <col align="left" valign="top" />
              <col />
            </colgroup>
            <tbody>
              <tr>
                <td>
                  <p>
                    <a id="config" name="config"></a><span class=
                    "term"><code class="filename">config-5.8.9</code></span>
                  </p>
                </td>
                <td>
                  <p>
                    包含所有内核配置选项的值
                  </p>
                </td>
              </tr>
              <tr>
                <td>
                  <p>
                    <a id="lfskernel" name="lfskernel"></a><span class=
                    "term"><code class=
                    "filename">vmlinuz-5.8.9-lfs-20200915-systemd</code></span>
                  </p>
                </td>
                <td>
                  <p>
                    Linux
                    系统的引擎，在启动计算机时，它是操作系统中被最早加载的部分。它检测并初始化计算机硬件，将它们以目录树的形式提供给软件，并将单个
                    CPU 封装成多任务系统，使多个用户程序看上去在同时执行。
                  </p>
                </td>
              </tr>
              <tr>
                <td>
                  <p>
                    <a id="System.map" name="System.map"></a><span class=
                    "term"><code class=
                    "filename">System.map-5.8.9</code></span>
                  </p>
                </td>
                <td>
                  <p>
                    地址和符号列表；它将内核函数和数据结构映射为入口点和地址
                  </p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="navfooter">
      <ul>
        <li class="prev">
          <a accesskey="p" href="fstab.html" title="创建 /etc/fstab 文件">上一页</a>
          <p>
            创建 /etc/fstab 文件
          </p>
        </li>
        <li class="next">
          <a accesskey="n" href="grub.html" title="使用 GRUB 设定引导过程">下一页</a>
          <p>
            使用 GRUB 设定引导过程
          </p>
        </li>
        <li class="up">
          <a accesskey="u" href="chapter10.html" title=
          "第&nbsp;10&nbsp;章&nbsp;使 LFS 系统可引导">上一级</a>
        </li>
        <li class="home">
          <a accesskey="h" href="../index.html" title=
          "Linux From Scratch - 版本 20200915-systemd，中文翻译版">起始页</a>
        </li>
      </ul>
    </div>
  </body>
</html>
