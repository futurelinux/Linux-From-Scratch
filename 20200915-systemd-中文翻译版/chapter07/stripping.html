<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=utf-8" />
    <title>
      7.14.&nbsp;清理和备份临时系统
    </title>
    <link rel="stylesheet" type="text/css" href="../stylesheets/lfs.css" />
    <meta name="generator" content="DocBook XSL Stylesheets V1.79.1" />
    <link rel="stylesheet" href="../stylesheets/lfs-print.css" type=
    "text/css" media="print" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>
  <body class="lfs" id="lfs-20200915-systemd，中文翻译版">
    <div class="navheader">
      <h4>
        Linux From Scratch - 版本 20200915-systemd，中文翻译版
      </h4>
      <h3>
        第&nbsp;7&nbsp;章&nbsp;进入 Chroot 并构建其他临时工具
      </h3>
      <ul>
        <li class="prev">
          <a accesskey="p" href="util-linux.html" title=
          "Util-linux-2.36">上一页</a>
          <p>
            Util-linux-2.36
          </p>
        </li>
        <li class="next">
          <a accesskey="n" href="../part4.html" title="构建 LFS 系统">下一页</a>
          <p>
            构建 LFS 系统
          </p>
        </li>
        <li class="up">
          <a accesskey="u" href="chapter07.html" title=
          "第&nbsp;7&nbsp;章&nbsp;进入 Chroot 并构建其他临时工具">上一级</a>
        </li>
        <li class="home">
          <a accesskey="h" href="../index.html" title=
          "Linux From Scratch - 版本 20200915-systemd，中文翻译版">起始页</a>
        </li>
      </ul>
    </div>
    <div class="sect1" lang="zh-cn" xml:lang="zh-cn">
      <h1 class="sect1">
        <a id="ch-tools-stripping" name="ch-tools-stripping"></a>7.14.
        清理和备份临时系统
      </h1>
      <p>
        libtool .la 文件仅在链接到静态库时有用。在使用动态共享库时它们没有意义，甚至有害，特别是对于非 autotools
        构建系统。仍然在 chroot 环境中，运行命令删除它们：
      </p>
      <pre class="userinput"><kbd class=
      "command">find /usr/{lib,libexec} -name \*.la -delete</kbd></pre>
      <p>
        删除临时工具的文档，以防止它们进入最终构建的系统，并节省大约 35 MB：
      </p>
      <pre class="userinput"><kbd class=
      "command">rm -rf /usr/share/{info,man,doc}/*</kbd></pre>
      <div class="admon note">
        <img alt="[注意]" src="../images/note.png" />
        <h3>
          注意
        </h3>
        <p>
          本节中的其余步骤都是可选的。不过，一旦您开始在<a class="xref" href=
          "../chapter08/chapter08.html" title=
          "第&nbsp;8&nbsp;章&nbsp;安装基本系统软件">第 8
          章</a>中安装软件包，临时工具就会被覆盖。因此，按照下面描述的步骤备份临时工具可能是个好主意。其余步骤只有在您的磁盘空间非常紧张时才需要执行。
        </p>
      </div>
      <p>
        以下步骤在 chroot 环境之外进行。换句话说，您需要在继续操作之前退出 chroot 环境。这样做的主要原因是：
      </p>
      <div class="itemizedlist">
        <ul>
          <li class="listitem">
            <p>
              保证在操作时，目标文件不会被使用。
            </p>
          </li>
          <li class="listitem">
            <p>
              访问 chroot 环境之外的文件系统位置，以写入或读取备份档案，备份档案不应存放在 <code class=
              "filename">$LFS</code> 目录树中，以保证安全。
            </p>
          </li>
        </ul>
      </div>
      <p>
        退出 chroot 环境，并解除挂载内核虚拟文件系统：
      </p>
      <div class="admon note">
        <img alt="[注意]" src="../images/note.png" />
        <h3>
          注意
        </h3>
        <p>
          以下给出的所有步骤都以 <code class="systemitem">root</code>
          身份执行。请非常小心地执行命令，错误的命令可能修改您的宿主系统。特别注意环境变量 <code class=
          "envar">LFS</code> 会自动为用户 <code class="systemitem">lfs</code>
          设定，但可能<span class="emphasis"><em>没有</em></span>为 <code class=
          "systemitem">root</code> 设定。无论何时，只要准备以 <code class=
          "systemitem">root</code> 身份执行命令，一定要确认 <code class=
          "envar">LFS</code> 变量正确设定。<a class="xref" href=
          "../chapter02/aboutlfs.html" title=
          "2.6.&nbsp;设置 $LFS 环境变量">第&nbsp;2.6&nbsp;节 “设置 $LFS
          环境变量”</a>已经讨论了这个问题。
        </p>
      </div>
      <pre class="userinput"><kbd class="command">exit
umount $LFS/dev{/pts,}
umount $LFS/{sys,proc,run}</kbd></pre>
      <div class="sect2" lang="zh-cn" xml:lang="zh-cn">
        <h2 class="sect2">
          7.14.1. 移除无用内容
        </h2>
        <p>
          如果 LFS 分区比较小，好消息是，有些无用的内容可以删除。到现在为止，已经构建的可执行文件和库包含大约 90MB 的无用调试符号。
        </p>
        <p>
          从二进制文件移除调试符号：
        </p>
        <pre class="userinput"><kbd class=
        "command">strip --strip-debug $LFS/usr/lib/*
strip --strip-unneeded $LFS/usr/{,s}bin/*
strip --strip-unneeded $LFS/tools/bin/*</kbd></pre>
        <p>
          以上命令会跳过一些文件，并报告说无法识别它们的格式。这些文件大多数都是脚本文件，而不是二进制文件。
        </p>
        <p>
          注意<span class="emphasis"><em>不要</em></span>对库文件使用 <em class=
          "parameter"><code>--strip-unneeded</code></em>
          选项。这会损坏静态库，结果工具链软件包都要重新构建。
        </p>
        <p>
          现在，您应该保证 chroot 分区有至少 5 GB 的可用空间，以在下一阶段构建和安装 Glibc 和
          GCC。如果空间足够构建和安装 Glibc，那么构建和安装剩余的软件包就不成问题。您可以使用命令 <span class=
          "command"><strong>df -h $LFS</strong></span> 查询磁盘可用空间。
        </p>
      </div>
      <div class="sect2" lang="zh-cn" xml:lang="zh-cn">
        <h2 class="sect2">
          7.14.2. 备份
        </h2>
        <p>
          现在已经建立了必要的工具，可以考虑备份它们。如果对之前构建的软件包进行的各项检查都没有发现问题，即可判定您的临时工具状态良好，可以将它们备份起来供以后重新使用。如果在后续章节发生了无法挽回的错误，通常来说，最好的办法是删除所有东西，然后
          (更小心地) 从头开始。不幸的是，这也会删除所有临时工具。为了避免浪费时间对已经构建成功的部分进行返工，可以准备一个备份。
        </p>
        <p>
          确认在 <code class="systemitem">root</code> 的主目录中，有至少 600 MB 的可用存储空间
          (源代码压缩包也会被包含在备份档案中)。
        </p>
        <p>
          运行以下命令，创建备份档案：
        </p>
        <pre class="userinput"><kbd class="command">cd $LFS &amp;&amp;
tar -cJpf $HOME/lfs-temp-tools-20200915-systemd.tar.xz .</kbd></pre>
        <p>
          可以将 <code class="envar">$HOME</code> 替换成您选择的其他目录，如果您不想将备份存储在
          <code class="systemitem">root</code> 的主目录中：
        </p>
      </div>
      <div class="sect2" lang="zh-cn" xml:lang="zh-cn">
        <h2 class="sect2">
          7.14.3. 还原
        </h2>
        <p>
          如果您犯下了一些错误，并不得不重新开始构建，您可以使用备份档案还原临时工具，节约一些工作时间。由于源代码在 <code class=
          "filename">$LFS</code> 中，它们也包含在备份档案内，因此不需要重新下载它们。在确认 <code class=
          "envar">$LFS</code>设定正确后，运行以下命令从备份档案进行还原：
        </p>
        <pre class="screen"><code class="computeroutput">cd $LFS &amp;&amp;
rm -rf ./* &amp;&amp;
tar -xpf $HOME/lfs-temp-tools-20200915-systemd.tar.xz</code></pre>
        <p>
          再一次复查环境是否配置正确，即可继续构建系统。
        </p>
        <div class="admon important">
          <img alt="[重要]" src="../images/important.png" />
          <h3>
            重要
          </h3>
          <p>
            如果您在移除调试符号，进行备份，或从备份进行恢复时退出了 chroot 环境，记得按照<a class="xref" href=
            "kernfs.html" title="7.3.&nbsp;准备虚拟内核文件系统">第&nbsp;7.3&nbsp;节
            “准备虚拟内核文件系统”</a>的描述重新挂载内核虚拟文件系统，并重新进入 chroot 环境 (参阅<a class=
            "xref" href="chroot.html" title=
            "7.4.&nbsp;进入 Chroot 环境">第&nbsp;7.4&nbsp;节 “进入 Chroot
            环境”</a>)，再继续进行构建。
          </p>
        </div>
      </div>
    </div>
    <div class="navfooter">
      <ul>
        <li class="prev">
          <a accesskey="p" href="util-linux.html" title=
          "Util-linux-2.36">上一页</a>
          <p>
            Util-linux-2.36
          </p>
        </li>
        <li class="next">
          <a accesskey="n" href="../part4.html" title="构建 LFS 系统">下一页</a>
          <p>
            构建 LFS 系统
          </p>
        </li>
        <li class="up">
          <a accesskey="u" href="chapter07.html" title=
          "第&nbsp;7&nbsp;章&nbsp;进入 Chroot 并构建其他临时工具">上一级</a>
        </li>
        <li class="home">
          <a accesskey="h" href="../index.html" title=
          "Linux From Scratch - 版本 20200915-systemd，中文翻译版">起始页</a>
        </li>
      </ul>
    </div>
  </body>
</html>
