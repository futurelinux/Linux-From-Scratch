#!/bin/bash 
set -e

TMP=${TMP:-$(mktemp -d)}
LOG=${LOG:-$(dirname $0)/log}
SRC=${SRC:-/home/sources}

pkgname=plasma
#pkgver=5.20.4
pkgver=5.19.4

rm -fr $TMP
mkdir -p $TMP $LOG


{ time \
   {

    mkdir -p $SRC/$pkgname-$pkgver
    cd $SRC/$pkgname-$pkgver

#    url=http://download.kde.org/stable/$pkgname/$pkgver/
#    wget -r -nH -nd -A '*.xz' -np $url

    cat > $pkgname-$pkgver.md5 << "EOF"
018aa45f5cf8e43e7a20618928affebe  kdecoration-5.19.4.tar.xz
3f371e5e60fb8e884af6c6ee247b0e8d  libkscreen-5.19.4.tar.xz
5cafda895bbfa0c06e93c53616b89700  libksysguard-5.19.4.tar.xz
108b5e62a2abca19fcfa3b4ff8f131f3  breeze-5.19.4.tar.xz
2cb9cf02aa9e3c2b8e676165b99f8774  breeze-gtk-5.19.4.tar.xz
67ac644f6ef96bf5b83066022345b4e0  kscreenlocker-5.19.4.tar.xz
0df5f8e9868151a2899ba81f5dec567b  oxygen-5.19.4.tar.xz
d1ce45d4d530d1257416ad1c0ff0286f  kinfocenter-5.19.4.tar.xz
79a948dbf0bb8c83f1f2ee17efd61385  ksysguard-5.19.4.tar.xz
4be1ba7337efe304d0b41a899edc5dc5  kwayland-server-5.19.4.tar.xz
197cadd24436310957258d2b40244ae8  kwin-5.19.4.tar.xz
15d58fbcfcf42d86629af7a77860e5a3  plasma-workspace-5.19.4.tar.xz
6a6d4347ea08f7dbce275fec3931bf26  bluedevil-5.19.4.tar.xz
972626bf6107585561f9f6335d3f8e16  kde-gtk-config-5.19.4.tar.xz
b73b47db04afcb39c6a5547fc4b715dc  khotkeys-5.19.4.tar.xz
0b8fa3d76cb2b6f87d3d76884773d5b5  kmenuedit-5.19.4.tar.xz
60223cfe9581d0913a421877a1946dab  kscreen-5.19.4.tar.xz
a89d3e90f4595b2acb7d911584f1883d  kwallet-pam-5.19.4.tar.xz
b471f4de79180257d05baebb6b9b587e  kwayland-integration-5.19.4.tar.xz
96faee06be1d88890c421b4d6334b783  kwrited-5.19.4.tar.xz
edcdefa304ed8df4d89e2bb48cb1cdd2  milou-5.19.4.tar.xz
a5af79f15adec8b2dd19ce286e575691  plasma-nm-5.19.4.tar.xz
f6eff79bb6a683e66208228ff566c116  plasma-pa-5.19.4.tar.xz
569c55902960eda4658634bac40dd22e  plasma-workspace-wallpapers-5.19.4.tar.xz
0a3f401968a27c3ae5caec07064c2343  polkit-kde-agent-1-5.19.4.tar.xz
9a2c2cbd8df0d5ce5133b842fa5ed636  powerdevil-5.19.4.tar.xz
1f1ea5c20ef9b90f106a2d25a7128a35  plasma-desktop-5.19.4.tar.xz
a8fefae0ae99a25f31c798b921d42564  kdeplasma-addons-5.19.4.tar.xz
3344cda599e9a33c510c9113f9da3948  kgamma5-5.19.4.tar.xz
e490ae9cef3e092124047dbbbcf0a3e5  ksshaskpass-5.19.4.tar.xz
#e211c0b303736f2c913f7eee4b112792  plasma-sdk-5.19.4.tar.xz
da829188c6b8c5116cb156b388adf1b8  sddm-kcm-5.19.4.tar.xz
0787296981e74adb829df253e6cd8a82  user-manager-5.19.4.tar.xz
99e3c88039d905aeee25984807d04f22  discover-5.19.4.tar.xz
#70f67b313e08ff3735c5dabcc4d34d2f  breeze-grub-5.19.4.tar.xz
#a38f1c99c6f43ce767a978319f87a011  breeze-plymouth-5.19.4.tar.xz
c2340132ae128347a83fa8748a46ed9d  kactivitymanagerd-5.19.4.tar.xz
10fea9aa0c4a74dce276bd006f56fdc0  plasma-integration-5.19.4.tar.xz
7645d39b27be8f378b2fe66a9e7a4734  plasma-tests-5.19.4.tar.xz
#74b4d61d44f5181e06fb5ae467f84d2d  plymouth-kcm-5.19.4.tar.xz
a4831d1a9f75b378e690daa07a543a88  xdg-desktop-portal-kde-5.19.4.tar.xz
39c97b134ab62d432187b2fadccacc11  drkonqi-5.19.4.tar.xz
b74993d79c92e8e39cf4910b2401c8f2  plasma-vault-5.19.4.tar.xz
b43af2c7267fcfd591c9b3d1b94dfa80  plasma-browser-integration-5.19.4.tar.xz
d0aa151e8dfe37bc412bf4a9fdfa027d  kde-cli-tools-5.19.4.tar.xz
5d0d2934a79dcd46e10165812ea69cc9  systemsettings-5.19.4.tar.xz
3e05594393cba476cf41c9001fe152f5  plasma-thunderbolt-5.19.4.tar.xz
#6fcb468827748d81a3d79a862e80ee52  plasma-nano-5.19.4.tar.xz
#13d0a1017e9a44fc91b27147866ff36b  plasma-phone-components-5.19.4.tar.xz
EOF

#    cat > $pkgname-$pkgver.md5 << "EOF"
#af10a41b15cb81f3cc405e31ef9f17ed  kdecoration-5.20.4.tar.xz
#aee69339bac97b8b4c8ba073c48ac7ed  libkscreen-5.20.4.tar.xz
#44015317e6c496a2cbd0dbea00fafec5  libksysguard-5.20.4.tar.xz
#9000d1bfe0bb16ee499dbe5a5af9bb22  breeze-5.20.4.tar.xz
#f984413303ea9bfa8b09add47eea217a  breeze-gtk-5.20.4.tar.xz
#86f2e76c7408b2ccd327b4ffa7c81f41  kscreenlocker-5.20.4.tar.xz
#792f7f818c18f386118093bb0be035d1  oxygen-5.20.4.tar.xz
#b41353b8c832a2831f04fc180dbabadd  kinfocenter-5.20.4.tar.xz
#fd1267064fa9b085934cbe3f1e5aade7  ksysguard-5.20.4.tar.xz
#cf90264792369ba8bd4d4333a5b59c96  kwayland-server-5.20.4.tar.xz
#2e25eb98bbbc37eaa81d6061817bd164  kwin-5.20.4.tar.xz
#cb4867c20b81ffcd8adae56c3dec0d41  plasma-workspace-5.20.4.tar.xz
#ac4730c9c47016c1db92e1b1c66b585f  bluedevil-5.20.4.tar.xz
#ea24ffd849444b5ceba4a48023939311  kde-gtk-config-5.20.4.tar.xz
#856e51dfb18f2b51ca39db5af2b9707b  khotkeys-5.20.4.tar.xz
#257cba142fc1c13d328d6817b65cdc3a  kmenuedit-5.20.4.tar.xz
#b8a5116c94ea717b3b71f2fdcc59a881  kscreen-5.20.4.tar.xz
#aea33684c4ed4241e01e3753fd0ea132  kwallet-pam-5.20.4.tar.xz
#65d449b6a51fbff45c9cc65d601536ac  kwayland-integration-5.20.4.tar.xz
#09c0ef8c927c1b0798a41ae7b6ca1397  kwrited-5.20.4.tar.xz
#92e9003a449866335ef154c748846f46  milou-5.20.4.tar.xz
#e05dbd9e6617b49290616d323bc54daf  plasma-nm-5.20.4.tar.xz
#1eebbc148709b42dc4862a2d98fff85b  plasma-pa-5.20.4.tar.xz
#d96c17d9d589cd2ba833d60ac55208e5  plasma-workspace-wallpapers-5.20.4.tar.xz
#44e98339dbe238045d1e72d26282a74d  polkit-kde-agent-1-5.20.4.tar.xz
#5fd24e129d01354d6abaf8aa8766ed85  powerdevil-5.20.4.tar.xz
#ddd01d3a85e5efb2967b7dfa4f162b6f  plasma-desktop-5.20.4.tar.xz
#6e4d4f4717c6149d0213bdc6fbe4cc0e  kdeplasma-addons-5.20.4.tar.xz
#9cf80a513951a8cb8f540d2cc2315664  kgamma5-5.20.4.tar.xz
#7ac6d7e0d6849ce23e86b2ee5ad5d888  ksshaskpass-5.20.4.tar.xz
##717b10a56d338bb58383f0f3269fb531  plasma-sdk-5.20.4.tar.xz
#16f15fee8b435ac1ce0f304668f538b3  sddm-kcm-5.20.4.tar.xz
##0787296981e74adb829df253e6cd8a82  user-manager-5.20.4.tar.xz
#f6f126e5f6d84d8f47516badc7fb7e9c  discover-5.20.4.tar.xz
##b55f6f11e4fa29c39fce9c0d5568ca88  breeze-grub-5.20.4.tar.xz
##7d6977a3d6dea4e43ce03b81fc09ba2d  breeze-plymouth-5.20.4.tar.xz
#a74cf024d2e05837b813703daa364713  kactivitymanagerd-5.20.4.tar.xz
#5478e5bb63b40271143166dfbc3c7552  plasma-integration-5.20.4.tar.xz
#ae3ae24c4145ef01680f0120ee2693b8  plasma-tests-5.20.4.tar.xz
##791d267d4869ea743bbe4d47e798a4cb  plymouth-kcm-5.20.4.tar.xz
#c9a901323a72ccb071c1a2a9b20fe2d0  xdg-desktop-portal-kde-5.20.4.tar.xz
#4515e64c1758dc49a8ca9adb1113a37a  drkonqi-5.20.4.tar.xz
#594abf697ef7ba64ee5a2468a72c93dc  plasma-vault-5.20.4.tar.xz
#1832bd8fabaec98d880fa25ea2adc395  plasma-browser-integration-5.20.4.tar.xz
#3497d575211112126b26c50416ca1271  kde-cli-tools-5.20.4.tar.xz
#e1997939048be759b3344d05028c67bb  systemsettings-5.20.4.tar.xz
#3dd1492bd3ed8edf085a01b536c06a73  plasma-thunderbolt-5.20.4.tar.xz
##e07b202527e67af36503e96149b974b0  plasma-nano-5.20.4.tar.xz
##cda92e6b67f50ebf9bd9583593e9942d  plasma-phone-components-5.20.4.tar.xz
#EOF

#    md5sum  -c $pkgname-$pkgver.md5

    export KF5_PREFIX=/usr

    as_root()
    {
      if   [ $EUID = 0 ];        then $*
      elif [ -x /usr/bin/sudo ]; then sudo $*
      else                            su -c \\"$*\\"
      fi
    }

    export -f as_root

    while read -r line; do

        # Get the file name, ignoring comments and blank lines
        if $(echo $line | grep -E -q '^ *$|^#' ); then continue; fi
        file=$(echo $line | cut -d" " -f2)

        pkg=$(echo $file|sed 's|^.*/||')          # Remove directory
        packagedir=$(echo $pkg|sed 's|\.tar.*||') # Package directory

        tar -xf $file
        pushd $packagedir

           # Fix some build issues when generating some configuration files
           case $name in
             plasma-workspace)
               sed -i '/set.HAVE_X11/a set(X11_FOUND 1)' CMakeLists.txt
             ;;
          
             khotkeys)
               sed -i '/X11Extras/a set(X11_FOUND 1)' CMakeLists.txt
             ;;
          
             plasma-desktop)
               sed -i '/X11.h)/i set(X11_FOUND 1)' CMakeLists.txt
             ;;
           esac

           mkdir build
           cd    build

           cmake -DCMAKE_INSTALL_PREFIX=$KF5_PREFIX \
                 -DCMAKE_BUILD_TYPE=Release         \
                 -DBUILD_TESTING=OFF                \
                 -Wno-dev ..

            make
            as_root make install
        popd


        as_root rm -rf $packagedir
        as_root /sbin/ldconfig

    done < $pkgname-$pkgver.md5

    cat > /etc/pam.d/kde << "EOF" 
# Begin /etc/pam.d/kde

auth     requisite      pam_nologin.so
auth     required       pam_env.so

auth     required       pam_succeed_if.so uid >= 1000 quiet
auth     include        system-auth

account  include        system-account
password include        system-password
session  include        system-session

# End /etc/pam.d/kde
EOF

    cat > /etc/pam.d/kde-np << "EOF" 
# Begin /etc/pam.d/kde-np

auth     requisite      pam_nologin.so
auth     required       pam_env.so

auth     required       pam_succeed_if.so uid >= 1000 quiet
auth     required       pam_permit.so

account  include        system-account
password include        system-password
session  include        system-session

# End /etc/pam.d/kde-np
EOF

    cat > /etc/pam.d/kscreensaver << "EOF"
# Begin /etc/pam.d/kscreensaver

auth    include system-auth
account include system-account

# End /etc/pam.d/kscreensaver
EOF

    }
} 2>&1 | tee $pkgname.log
    
[ $PIPESTATUS = 0 ] && mv $pkgname.log $LOG || exit $PIPESTATUS

rm -fr $TMP
